<meta name="viewport" content="width=device-width, initial-scale=1">

<h1>Food Planner</h1>
<p>Use this tool to plan your food!</p>

<p>Total Calories: <span id=totalCalories>?</span></p>
<p>Total Carbs: <span id=totalCarbs>?</span></p>
<div style="max-width: 500px" id="reader"></div>

<script src="html5-qrcode.min.js"></script>

<script>
class Food {
  constructor(uuid = self.crypto.randomUUID(), name = "", calories = 0, carbs = 0) {
    this.uuid = uuid
    this.name = name
    this.calories = calories
    this.carbs = carbs
  }
}

class FoodRenderer {
  constructor(food) {
    this.food = new Food(food.uuid, food.name, food.calories)
  }
  
  static renderAll(parent) {
    let foods = this.all()
    Object.keys(foods).forEach(uuid => this.renderFood(foods[uuid]))
    this.renderBlankFood()
    this.updateTotals()
  }
  
  static renderFood(food) {
    let foodRenderer = new FoodRenderer(food)
    foodRenderer.render()
    foodRenderer.renderDeleteButton(foodRenderer.div)
    
    return foodRenderer
  }
  
  static renderBlankFood() {
    let foodRenderer = new FoodRenderer(new Food())
    foodRenderer.render()
    
    foodRenderer.nameInput
                .addEventListener("input", () => {
                  foodRenderer.renderDeleteButton(foodRenderer.div)
                  this.renderBlankFood()
                }, { once: true })
  }
  
  static all() {
    return JSON.parse(localStorage.getItem("foods")) || {}
  } 
  
  renderNameInput(parent) {
    this.nameInput = document.createElement("input")
    this.nameInput.placeholder = "Name"
    this.nameInput.value = this.food.name
    this.nameInput.addEventListener("blur", () => this.save())
    
    parent.appendChild(this.nameInput)
    return this.nameInput
  }
  
  renderCalorieInput(parent) {
    this.calInput = document.createElement("input")
    this.calInput.type = "number"
    this.calInput.pattern = "[0-9]"
    this.calInput.value = this.food.calories
    this.calInput.addEventListener("input", () => this.save())
    
    parent.appendChild(this.calInput)
    return this.nameInput
  }
  
  renderCarbsInput(parent) {
    this.carbsInput = document.createElement("input")
    this.carbsInput.type = "number"
    this.carbsInput.pattern = "[0-9]"
    this.carbsInput.value = this.food.carbs
    this.carbsInput.addEventListener("input", () => this.save())
    
    parent.appendChild(this.carbsInput)
    return this.nameInput
  } 
  
  renderDeleteButton(parent) {
    let deleteButton = document.createElement("button")
    deleteButton.innerText = "Delete"
    deleteButton.addEventListener("click", () => this.delete())
    parent.appendChild(deleteButton)
    
    return deleteButton
  }
  
  render() {
    this.div = document.createElement("div")
    this.renderNameInput(this.div)
    
    this.renderCalorieInput(this.div)
    this.renderCarbsInput(this.div)

    document.body.appendChild(this.div)
  }
  
  save() {
    this.food.name = this.nameInput.value
    this.food.calories = parseInt(this.calInput.value)
    this.food.carbs = parseInt(this.carbsInput.value)
    this.calInput.value = this.food.calories
    let foods = this.constructor.all()
    foods[this.food.uuid] = this.food
    localStorage.setItem("foods", JSON.stringify(foods))
    
    this.constructor.updateTotals()
  }
  
  delete() {
    this.div.remove()

    let foods = this.constructor.all()
    delete foods[this.food.uuid]

    localStorage.setItem("foods", JSON.stringify(foods))
  }
  
  static updateTotals() {
    document.getElementById("totalCalories").innerText = this.totalCalories()
    document.getElementById("totalCarbs").innerText = this.totalCarbs()
  }
  
  static totalCalories() {
    return Object.values(this.all()).reduce((total, food) => total + (parseInt(food.calories) || 0), 0)
  }
  
  static totalCarbs() {
    return Object.values(this.all()).reduce((total, food) => total + (parseInt(food.carbs) || 0), 0)
  }
}

FoodRenderer.renderAll()

async function onScanSuccess(decodedText, decodedResult) {
    await fetch(`https://world.openfoodfacts.org/api/v3/product/${decodedText}.json`).then((r) => r.json()).then((data) => {
      FoodRenderer.renderFood(new Food(self.crypto.randomUUID(), `${data["product"]["brands"]} ${data["product"]["product_name"]}`, data["product"]["nutriments"]["energy-kcal"])).save()
    })
}

var html5QrcodeScanner = new Html5QrcodeScanner(
	"reader", { fps: 10, qrbox: 250, showTorchButtonIfSupported: true})
html5QrcodeScanner.render(onScanSuccess)
</script>

