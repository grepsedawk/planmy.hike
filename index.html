<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">

<h1>Food Planner</h1>
<p>Use this tool to plan your food!</p>

<div style="max-width: 500px" id="reader"></div>
<div id=totals></div>
<script src="html5-qrcode.min.js"></script>

<script>
class SectionConfig {
  constructor(miles) {
    this.miles = miles
  }
}

class Food {
  constructor(uuid = self.crypto.randomUUID(), name = "", calories = 0, carbs = 0, protein = 0, fat = 0) {
    this.uuid = uuid
    this.name = name
    this.calories = calories
    this.carbs = carbs
    this.protein = protein
    this.fat = fat
  }
}

class FoodRenderer {
  constructor(food) {
    this.food = new Food(food.uuid, food.name, food.calories, food.carbs, food.protein, food.fat)
  }
  
  static render(parent) {
    let foods = this.all()
    Object.keys(foods).forEach(uuid => this.renderFood(foods[uuid]))
    this.renderBlankFood()
  }
  
  static renderFood(food) {
    let foodRenderer = new FoodRenderer(food)
    foodRenderer.render()
    foodRenderer.renderDeleteButton(foodRenderer.div)
    
    return foodRenderer
  }
  
  static renderBlankFood() {
    let foodRenderer = new FoodRenderer(new Food())
    foodRenderer.render()
    
    foodRenderer.nameInput
                .addEventListener("input", () => {
                  foodRenderer.renderDeleteButton(foodRenderer.div)
                  this.renderBlankFood()
                }, { once: true })
  }
  
  static all() {
    return JSON.parse(localStorage.getItem("foods")) || {}
  } 
  
  renderNameInput(parent) {
    this.nameInput = document.createElement("input")
    this.nameInput.placeholder = "Name"
    this.nameInput.value = this.food.name
    this.nameInput.addEventListener("blur", () => this.save())
    
    parent.appendChild(this.nameInput)
 
    return this.nameInput
  }
  
  renderNumberInput(parent, initialValue = 0) {
    let field = document.createElement("input")
    field.type = "number"
    field.value = initialValue
    field.addEventListener("input", () => this.save())
    
    parent.appendChild(field)
    
    return field
  }
  
  renderDeleteButton(parent) {
    let deleteButton = document.createElement("button")
    deleteButton.innerText = "Delete"
    deleteButton.addEventListener("click", () => this.delete())
    parent.appendChild(deleteButton)
    
    return deleteButton
  }
  
  render() {
    this.div = document.createElement("div")
    this.renderNameInput(this.div)
    
    this.calInput = this.renderNumberInput(this.div, this.food.calories)
    this.carbsInput = this.renderNumberInput(this.div, this.food.carbs)
    this.proteinInput = this.renderNumberInput(this.div, this.food.protein)
    this.fatInput = this.renderNumberInput(this.div, this.food.fat)

    document.body.appendChild(this.div)
  }
  
  save() {
    this.food.name = this.nameInput.value
    this.food.calories = parseInt(this.calInput.value)
    this.food.carbs = parseInt(this.carbsInput.value)
    this.food.protein = parseInt(this.proteinInput.value)
    this.food.fat = parseInt(this.fatInput.value)
    
    let foods = this.constructor.all()
    foods[this.food.uuid] = this.food
    localStorage.setItem("foods", JSON.stringify(foods))
    
    TotalsRenderer.render(document.getElementById("totals"))
  }
  
  delete() {
    this.div.remove()

    let foods = this.constructor.all()
    delete foods[this.food.uuid]

    localStorage.setItem("foods", JSON.stringify(foods))
  }
  
  
}

class TotalsRenderer {
  static render(parent) {
    new TotalsRenderer(parent).render()
  }
  
  constructor(parent) {
    this.foods = FoodRenderer.all()
    this.parent = parent
  }
  
  render() { 
    this.parent.innerHTML = `<p>Total Calories: ${this.totalCalories()}</p>`
    this.parent.innerHTML += `<p>Total Carbs: ${this.totalCarbs()}</p>`
    this.parent.innerHTML += `<p>Total Protein: ${this.totalProtein()}</p>`
    this.parent.innerHTML += `<p>Total Fat: ${this.totalFat()}</p>`
    this.parent.innerHTML += `<p>Protein / Carb: ${this.proteinCarbRatio()}</p>`
  }
      
  totalCalories() {
    return Object.values(this.foods).reduce((total, food) => total + (parseInt(food.calories) || 0), 0)
  }
  
  totalCarbs() {
    return Object.values(this.foods).reduce((total, food) => total + (parseInt(food.carbs) || 0), 0)
  }
  
  totalProtein() {
    return Object.values(this.foods).reduce((total, food) => total + (parseInt(food.protein) || 0), 0)
  }
  
  totalFat() {
    return Object.values(this.foods).reduce((total, food) => total + (parseInt(food.fat) || 0), 0)
  }
  
  proteinCarbRatio() {
    return this.totalProtein() / this.totalCarbs()
  }
}

class BarcodeScannerRenderer {
  config = { fps: 10, qrbox: { width: 250, height: 250 } }
  
  static render() {
    const button = document.createElement("button")
    button.style = "position: absolute; bottom: 10px; right: 10px; height: 3rem; width: 3rem"
    button.innerText = "ðŸ“·"
    button.addEventListener("click", () => new BarcodeScannerRenderer().start())
    
    document.body.appendChild(button)
  } 
  
  start() {
    let div = document.createElement("div")
    div.style = "position: fixed; top: 0; left: 0; width: 100vw;"
    let scanner = document.createElement("div")
    scanner.id = "scanner"
    scanner.style = "width: 100%"
    div.appendChild(scanner)
    document.body.appendChild(div)
  
    this.html5QrCode = new Html5Qrcode("scanner")
    this.html5QrCode.start(
      { facingMode: "environment" },
      this.config,
      (code, result) => {
        this.cachedBarcodeLookup(code)
          .then((r) => r.json())
          .then((data) => {
        FoodRenderer.renderFood(new Food(
          self.crypto.randomUUID(),
          `${data["product"]["brands"]} ${data["product"]["product_name"]}`,
          data["product"]["nutriments"]["energy-kcal"],
          data["product"]["nutriments"]["carbohydrates"],
          data["product"]["nutriments"]["proteins"],
          data["product"]["nutriments"]["fat"]
        )).save()
    })
    this.html5QrCode.stop().then(() => {
      div.remove()
    }).catch((err) => {})
    }
    )
  }
  
  async cachedBarcodeLookup(code) {
  console.log(`cachedBarcodeLookup(${code})`)
    const url = `https://world.openfoodfacts.org/api/v3/product/${code}.json`
    return caches.open("barcodes_v1").then((cache) => cache.match(url).then((r) => r || cache.add(url).then(then((r) => r))))
  } 
}

TotalsRenderer.render(document.getElementById("totals"))
FoodRenderer.render()
BarcodeScannerRenderer.render()
</script>

